<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EntiWebOS 5.0 - Store Update</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* --- Design Variablen: Orange/Gelb Theme --- */
        :root {
            --taskbar-height: 56px;
            --desktop-bg: #0f172a; 
            --window-bg: #1e293b; 
            --taskbar-bg: rgba(15, 23, 42, 0.95);
            --accent-primary: #f97316; /* Orange-500 */
            --accent-secondary: #fbbf24; /* Amber-400 */
            --text-color: #e2e8f0;
            --border-color: #334155;
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: var(--desktop-bg);
            background-image: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
            color: var(--text-color);
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #desktop {
            height: calc(100vh - var(--taskbar-height));
            position: relative;
            overflow: hidden;
        }
        #taskbar {
            height: var(--taskbar-height);
            backdrop-filter: blur(12px);
            background-color: var(--taskbar-bg);
            border-top: 1px solid rgba(249, 115, 22, 0.3);
            position: fixed;
            bottom: 0; left: 0; right: 0;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }

        /* --- Fenster-Stile --- */
        .window {
            position: absolute;
            min-width: 280px;
            min-height: 200px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(249, 115, 22, 0.2);
            background-color: var(--window-bg);
            display: none;
            resize: both;
            animation: popIn 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            border: 1px solid var(--border-color);
        }
        
        @media (max-width: 640px) {
            .window {
                border-radius: 0; border: none; resize: none;
            }
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.92) translateY(15px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .window-title-bar {
            cursor: grab; background: #1e293b; user-select: none;
            border-bottom: 1px solid var(--border-color); touch-action: none;
        }
        
        .window.active {
            z-index: 500; border-color: var(--accent-primary);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.9), 0 0 0 1px var(--accent-primary);
        }
        
        .window-content {
            height: calc(100% - 48px); overflow: hidden; background-color: #0f172a;
        }
        
        /* --- Startmen√º Stil --- */
        #start-menu {
            position: absolute;
            bottom: calc(var(--taskbar-height) + 8px);
            left: 8px;
            width: 340px;
            background-color: rgba(30, 41, 59, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(249, 115, 22, 0.3);
            border-radius: 16px;
            padding: 16px;
            display: none;
            z-index: 1001;
            transform-origin: bottom left;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            animation: slideUp 0.2s ease-out;
            display: flex; flex-direction: column;
            max-height: 80vh;
        }
        
        @media (max-width: 640px) {
            #start-menu {
                left: 0; right: 0; width: 100%; bottom: var(--taskbar-height);
                border-radius: 16px 16px 0 0; border: none; border-top: 1px solid var(--accent-primary);
            }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* App Icon Hover Effects */
        .app-icon-container { transition: all 0.2s; }
        .app-icon-container:active { transform: scale(0.95); }
        
        /* Delete Badge for User Apps */
        .delete-badge {
            position: absolute; top: -5px; right: -5px;
            background: red; color: white; border-radius: 50%;
            width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;
            font-size: 12px; opacity: 0; transition: opacity 0.2s;
            z-index: 10;
        }
        .app-icon-container:hover .delete-badge { opacity: 1; }
    </style>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- System Core ---
            const desktop = document.getElementById('desktop');
            const taskbarApps = document.getElementById('taskbar-apps');
            const startMenuButton = document.getElementById('start-button');
            const startMenu = document.getElementById('start-menu');
            const searchInput = document.getElementById('start-search');
            let zIndexCounter = 100;
            let activeWindow = null;
            let allApps = {}; // Stores merged system and user apps

            // --- App Manager (Web-to-App Logic) ---
            const AppManager = {
                getKey: () => 'enti_webos_apps_v1',
                getCustomApps: () => {
                    const data = localStorage.getItem(AppManager.getKey());
                    return data ? JSON.parse(data) : {};
                },
                install: (name, url, iconEmoji) => {
                    const apps = AppManager.getCustomApps();
                    const id = 'custom_' + Date.now();
                    apps[id] = {
                        id: id,
                        title: name,
                        url: url,
                        iconEmoji: iconEmoji,
                        isCustom: true
                    };
                    localStorage.setItem(AppManager.getKey(), JSON.stringify(apps));
                    window.dispatchEvent(new Event('enti-apps-update'));
                    return id;
                },
                uninstall: (id) => {
                    const apps = AppManager.getCustomApps();
                    if (apps[id]) {
                        delete apps[id];
                        localStorage.setItem(AppManager.getKey(), JSON.stringify(apps));
                        window.dispatchEvent(new Event('enti-apps-update'));
                    }
                }
            };

            // --- File System (Local Storage) ---
            const VFS = {
                getKey: () => 'enti_webos_fs_v1',
                getAll: () => {
                    const data = localStorage.getItem(VFS.getKey());
                    return data ? JSON.parse(data) : { 'Info.txt': 'Willkommen bei EntiWebOS 5.0!' };
                },
                save: (filename, content) => {
                    const fs = VFS.getAll(); fs[filename] = content;
                    localStorage.setItem(VFS.getKey(), JSON.stringify(fs));
                    window.dispatchEvent(new Event('enti-fs-update'));
                },
                delete: (filename) => {
                    const fs = VFS.getAll(); delete fs[filename];
                    localStorage.setItem(VFS.getKey(), JSON.stringify(fs));
                    window.dispatchEvent(new Event('enti-fs-update'));
                }
            };

            // --- Window Management ---
            function focusWindow(windowEl) {
                document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
                windowEl.style.zIndex = ++zIndexCounter;
                windowEl.classList.add('active');
                activeWindow = windowEl;
                updateTaskbarHighlight(windowEl.id);
            }

            function updateTaskbarHighlight(activeId) {
                document.querySelectorAll('.taskbar-item').forEach(item => {
                    item.classList.remove('bg-orange-600', 'text-white', 'shadow-md');
                    item.classList.add('text-gray-400', 'bg-transparent');
                });
                const taskbarItem = document.querySelector(`.taskbar-item[data-target="${activeId}"]`);
                if (taskbarItem) {
                    taskbarItem.classList.add('bg-orange-600', 'text-white', 'shadow-md');
                    taskbarItem.classList.remove('text-gray-400', 'bg-transparent');
                    taskbarItem.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }
            
            function closeWindow(windowEl, taskbarItem) {
                windowEl.style.opacity = '0'; windowEl.style.transform = 'scale(0.9)';
                setTimeout(() => { windowEl.remove(); taskbarItem.remove(); }, 200);
            }

            function openWindow(appId, app, extraData = null) {
                const windowId = `window-${appId}-${Date.now()}`;
                const isMobile = window.innerWidth < 640;

                const windowEl = document.createElement('div');
                windowEl.id = windowId;
                windowEl.className = 'window active flex flex-col';
                
                if (isMobile) {
                    windowEl.style.width = '100%'; windowEl.style.height = '100%';
                    windowEl.style.left = '0'; windowEl.style.top = '0'; windowEl.style.borderRadius = '0';
                } else {
                    windowEl.style.width = `${app.width || 600}px`; windowEl.style.height = `${app.height || 400}px`;
                    const left = Math.max(20, (desktop.offsetWidth - (app.width || 600)) / 2 + (Math.random() * 40 - 20));
                    const top = Math.max(20, (desktop.offsetHeight - (app.height || 400)) / 2 + (Math.random() * 40 - 20));
                    windowEl.style.left = `${left}px`; windowEl.style.top = `${top}px`;
                }
                
                windowEl.style.zIndex = ++zIndexCounter;
                windowEl.style.display = 'flex';

                // Icon logic: User apps use Emojis, System apps use SVG string
                const iconHtml = app.isCustom ? `<span class="text-xl">${app.iconEmoji}</span>` : app.icon;

                // Content generation
                let contentHTML = app.content ? app.content.replace(/\{\{ID\}\}/g, windowId) : '';
                // Special handling for Web-to-App (Custom Apps)
                if (app.isCustom) {
                    contentHTML = `
                        <div class="flex flex-col h-full">
                            <div class="bg-slate-900 p-1 text-center text-[10px] text-gray-500 truncate">${app.url}</div>
                            <iframe src="${app.url}" class="flex-grow border-none w-full bg-white"></iframe>
                        </div>
                    `;
                }

                windowEl.innerHTML = `
                    <div class="window-title-bar h-12 px-4 flex items-center justify-between text-gray-200 text-sm font-bold tracking-wide shrink-0">
                        <span class="flex items-center gap-3">
                            ${iconHtml}
                            <span class="truncate max-w-[150px]">${app.title}</span>
                        </span>
                        <div class="flex gap-2">
                            <button class="window-action-min w-8 h-8 flex items-center justify-center rounded hover:bg-slate-700 text-gray-400 hover:text-white"><i data-lucide="minus" class="w-5 h-5"></i></button>
                            <button class="window-action-close w-8 h-8 flex items-center justify-center rounded hover:bg-red-600 text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div class="window-content relative flex flex-col flex-grow">${contentHTML}</div>
                `;
                
                desktop.appendChild(windowEl);
                if (!app.isCustom) lucide.createIcons(); // Only re-render lucide for system apps
                focusWindow(windowEl);

                const taskbarItem = document.createElement('button');
                taskbarItem.className = 'taskbar-item flex-shrink-0 px-3 h-10 mx-1 rounded-lg transition-all flex items-center gap-2 bg-orange-600 text-white text-sm font-medium';
                taskbarItem.setAttribute('data-target', windowId);
                taskbarItem.innerHTML = `${iconHtml} <span class="hidden sm:inline truncate max-w-[80px]">${app.title}</span>`;
                
                taskbarItem.onclick = () => {
                    if (windowEl.classList.contains('active') && windowEl.style.display !== 'none') {
                        windowEl.style.display = 'none';
                        taskbarItem.classList.remove('bg-orange-600', 'text-white', 'shadow-md');
                        taskbarItem.classList.add('text-gray-400');
                    } else {
                        windowEl.style.display = 'flex';
                        focusWindow(windowEl);
                    }
                };
                taskbarApps.appendChild(taskbarItem);
                taskbarApps.scrollTo({ left: taskbarApps.scrollWidth, behavior: 'smooth' });

                windowEl.onmousedown = (e) => { if (!e.target.closest('.window-action-close')) focusWindow(windowEl); };
                windowEl.ontouchstart = (e) => { if (!e.target.closest('.window-action-close')) focusWindow(windowEl); };
                windowEl.querySelector('.window-action-close').onclick = () => closeWindow(windowEl, taskbarItem);
                windowEl.querySelector('.window-action-min').onclick = () => { windowEl.style.display = 'none'; };

                if (!isMobile) {
                    // Desktop Drag logic removed for brevity, assuming same as previous version
                    const titleBar = windowEl.querySelector('.window-title-bar');
                    let isDragging = false, startX, startY, initialLeft, initialTop;
                    titleBar.onmousedown = (e) => { if(!e.target.closest('button')) { isDragging=true; startX=e.clientX; startY=e.clientY; initialLeft=windowEl.offsetLeft; initialTop=windowEl.offsetTop; titleBar.style.cursor='grabbing'; } };
                    window.addEventListener('mousemove', (e) => { if(isDragging) { windowEl.style.left=`${initialLeft+(e.clientX-startX)}px`; windowEl.style.top=`${initialTop+(e.clientY-startY)}px`; } });
                    window.addEventListener('mouseup', () => { isDragging=false; titleBar.style.cursor='grab'; });
                }

                if (typeof app.init === 'function') app.init(windowEl, windowId, extraData);
            }

            // --- Curated Feature Pack (10 Micro-Apps) ---
            const generateMicroApps = () => {
                const curatedFeatures = [
                    { title: 'Focus Timer', icon: '‚è±Ô∏è', category: 'Produktivit√§t', blurb: '25/5 Fokus mit automatischem Rhythmus und Pausenerinnerung.' },
                    { title: 'Flash Ideas', icon: '‚ú®', category: 'Kreativit√§t', blurb: 'Schnelle Ideenlisten mit zuf√§lligen Kreativprompts.' },
                    { title: 'Pulse Charts', icon: 'üìä', category: 'Analyse', blurb: 'Mini-Dashboards mit Live-Dummy-Daten zum √úben.' },
                    { title: 'Auto Tasks', icon: 'üõ†Ô∏è', category: 'Automation', blurb: 'Vorlagen f√ºr wiederkehrende Abl√§ufe mit Checklisten.' },
                    { title: 'Sound Bed', icon: 'üéµ', category: 'Audio', blurb: 'Ambient-Sound-Mixer mit schnellen Presets.' },
                    { title: 'Learn Bytes', icon: 'üìö', category: 'Lernen', blurb: 'Kleine Lernkarten zum Sofort-√úberblicken.' },
                    { title: 'Mind Trace', icon: 'üß†', category: 'Reflexion', blurb: 'Gef√ºhrte Journaling-Prompts f√ºr den Tag.' },
                    { title: 'Globe Links', icon: 'üåê', category: 'Web', blurb: 'Schnellwahl f√ºr h√§ufige Research-Links.' },
                    { title: 'Spark Sketch', icon: 'üé®', category: 'Design', blurb: 'Mini-Canvas mit Farb-Presets und Exportbutton.' },
                    { title: 'Lightning Notes', icon: '‚ö°', category: 'Produktivit√§t', blurb: 'Kompakte Notizkarten mit Priorit√§tsmarker.' }
                ];

                const microApps = {};

                curatedFeatures.forEach((feature, index) => {
                    const idx = index + 1;
                    microApps[`micro_${idx}`] = {
                        title: feature.title,
                        icon: `<span class="text-xl">${feature.icon}</span>`,
                        category: feature.category,
                        width: 420,
                        height: 320,
                        showOnDesktop: false,
                        hideFromStart: true,
                        content: `
                            <div class="flex flex-col h-full bg-slate-900">
                                <div class="p-4 border-b border-slate-800">
                                    <div class="text-orange-400 text-xs font-bold">Update Pack 10</div>
                                    <div class="text-lg font-extrabold text-white">${feature.title}</div>
                                    <div class="text-[11px] text-gray-400">Kategorie: ${feature.category}</div>
                                </div>
                                <div class="flex-grow p-4 space-y-3 overflow-y-auto text-sm text-gray-200">
                                    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-3">
                                        <div class="font-semibold text-orange-200 mb-1">Sofort-Feature</div>
                                        <p class="text-xs text-gray-300 leading-relaxed">${feature.blurb}</p>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-[11px]">
                                        <div class="bg-slate-800/50 rounded-lg p-2 border border-slate-700/60"><div class="text-gray-400">Status</div><div id="micro-status-${idx}-{{ID}}" class="text-orange-300 font-bold">Bereit</div></div>
                                        <div class="bg-slate-800/50 rounded-lg p-2 border border-slate-700/60"><div class="text-gray-400">Kategorie</div><div class="text-white font-semibold">${feature.category}</div></div>
                                    </div>
                                    <button id="micro-run-${idx}-{{ID}}" class="w-full py-2 rounded-lg bg-orange-600 hover:bg-orange-500 text-white font-bold shadow-lg text-sm">Micro-Feature starten</button>
                                </div>
                            </div>
                        `,
                        init: (el, windowId) => {
                            const status = el.querySelector(`#micro-status-${idx}-${windowId}`);
                            const btn = el.querySelector(`#micro-run-${idx}-${windowId}`);
                            if (btn && status) {
                                btn.onclick = () => {
                                    status.textContent = 'L√§uft...';
                                    setTimeout(() => {
                                        status.textContent = 'Fertig';
                                        status.classList.add('text-green-300');
                                    }, 600);
                                };
                            }
                        }
                    };
                });

                return microApps;
            };

            const microApps = generateMicroApps();
            const featuresTotal = Object.keys(microApps).length;

            // --- System Apps ---
            const coreApps = {
                'store': {
                    title: 'EntiStore',
                    icon: '<i data-lucide="shopping-bag" class="w-5 h-5 text-green-400"></i>',
                    width: 500, height: 550,
                    content: `
                        <div class="flex flex-col h-full p-6 space-y-4 bg-[#1e293b] overflow-y-auto">
                            <div class="text-center mb-2">
                                <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-2"><i data-lucide="shopping-bag" class="w-8 h-8 text-green-400"></i></div>
                                <h2 class="text-xl font-bold text-white">App Installieren</h2>
                                <p class="text-xs text-gray-400">Verwandeln Sie jede Webseite in eine App</p>
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs text-gray-400 uppercase font-bold">App Name</label>
                                <input type="text" id="store-name-{{ID}}" class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-white focus:border-green-500 outline-none" placeholder="z.B. Wikipedia">
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs text-gray-400 uppercase font-bold">Webseite URL</label>
                                <input type="text" id="store-url-{{ID}}" class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-white focus:border-green-500 outline-none" placeholder="https://www.wikipedia.org">
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs text-gray-400 uppercase font-bold">Icon (Emoji)</label>
                                <div class="flex gap-2 overflow-x-auto pb-2" id="emoji-list-{{ID}}">
                                    <!-- Emojis injected by JS -->
                                </div>
                                <input type="hidden" id="store-icon-{{ID}}" value="??">
                            </div>
                            <button id="store-install-{{ID}}" class="w-full py-3 bg-green-600 hover:bg-green-500 rounded-lg font-bold text-white shadow-lg mt-4">Installieren</button>
                            
                            <div class="border-t border-slate-700 pt-4 mt-4">
                                <h3 class="text-sm font-bold text-white mb-2">Installierte Apps</h3>
                                <div id="store-list-{{ID}}" class="space-y-2"></div>
                            </div>
                        </div>
                    `,
                    init: (el, id) => {
                        const nameIn = el.querySelector(`#store-name-${id}`);
                        const urlIn = el.querySelector(`#store-url-${id}`);
                        const iconIn = el.querySelector(`#store-icon-${id}`);
                        const installBtn = el.querySelector(`#store-install-${id}`);
                        const emojiList = el.querySelector(`#emoji-list-${id}`);
                        const appList = el.querySelector(`#store-list-${id}`);

                        // Emojis setup
                        const emojis = ['??','??','??','??','??','??','??','??','??','??','??','?'];
                        emojis.forEach(emo => {
                            const btn = document.createElement('button');
                            btn.className = `w-10 h-10 rounded bg-slate-800 hover:bg-slate-700 text-xl flex-shrink-0 ${emo === '??' ? 'border-2 border-green-500' : ''}`;
                            btn.innerText = emo;
                            btn.onclick = () => {
                                iconIn.value = emo;
                                emojiList.querySelectorAll('button').forEach(b => b.classList.remove('border-2', 'border-green-500'));
                                btn.classList.add('border-2', 'border-green-500');
                            };
                            emojiList.appendChild(btn);
                        });

                        // Install logic
                        installBtn.onclick = () => {
                            if(!nameIn.value || !urlIn.value) return;
                            let url = urlIn.value;
                            if(!url.startsWith('http')) url = 'https://' + url;
                            AppManager.install(nameIn.value, url, iconIn.value);
                            nameIn.value = ''; urlIn.value = '';
                            installBtn.innerText = "Installiert!";
                            setTimeout(() => installBtn.innerText = "Installieren", 1500);
                            renderList();
                        };

                        const renderList = () => {
                            appList.innerHTML = '';
                            const customApps = AppManager.getCustomApps();
                            if(Object.keys(customApps).length === 0) appList.innerHTML = '<div class="text-xs text-gray-500 text-center">Keine eigenen Apps installiert.</div>';
                            Object.values(customApps).forEach(app => {
                                const row = document.createElement('div');
                                row.className = 'flex justify-between items-center bg-slate-800 p-2 rounded';
                                row.innerHTML = `<span class="flex items-center gap-2 text-sm text-gray-300"><span>${app.iconEmoji}</span> ${app.title}</span>`;
                                const delBtn = document.createElement('button');
                                delBtn.className = 'text-red-400 hover:text-red-300 text-xs px-2';
                                delBtn.innerText = 'L√∂schen';
                                delBtn.onclick = () => { AppManager.uninstall(app.id); renderList(); };
                                row.appendChild(delBtn);
                                appList.appendChild(row);
                            });
                        };
                        renderList();
                    }
                },
                'explorer': {
                    title: 'Explorer',
                    icon: '<i data-lucide="folder-open" class="w-5 h-5 text-yellow-500"></i>',
                    width: 650, height: 450,
                    content: `<div class="flex flex-col h-full bg-[#1e293b]"><div class="p-3 bg-slate-800 border-b border-slate-700 flex justify-between items-center"><span class="text-orange-500 font-bold text-sm">DATEIEN</span><button id="refresh-fs-{{ID}}" class="p-2 hover:bg-slate-700 rounded-full text-orange-400"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button></div><div id="file-list-{{ID}}" class="flex-grow p-4 grid grid-cols-3 sm:grid-cols-4 gap-4 content-start overflow-y-auto"></div></div>`,
                    init: (el, id) => {
                        const list = el.querySelector(`#file-list-${id}`);
                        const renderFiles = () => {
                            const files = VFS.getAll(); list.innerHTML = '';
                            const newBtn = document.createElement('div');
                            newBtn.className = 'flex flex-col items-center justify-center p-2 rounded-lg bg-slate-800/50 cursor-pointer border border-dashed border-slate-600 hover:border-orange-500';
                            newBtn.innerHTML = `<i data-lucide="plus" class="w-6 h-6 text-slate-400 mb-1"></i><span class="text-[10px]">Neu</span>`;
                            newBtn.onclick = () => openWindow('editor', systemApps.editor);
                            list.appendChild(newBtn);
                            Object.keys(files).forEach(fname => {
                                const f = document.createElement('div'); f.className = 'flex flex-col items-center p-2 rounded-lg hover:bg-slate-700 cursor-pointer relative group';
                                f.innerHTML = `<i data-lucide="file-text" class="w-8 h-8 text-slate-300 mb-2"></i><span class="text-xs text-gray-300 truncate w-full text-center">${fname}</span><button class="absolute top-0 right-0 text-red-400 opacity-0 group-hover:opacity-100 bg-slate-900 rounded-full p-1 del-btn"><i data-lucide="trash-2" class="w-3 h-3"></i></button>`;
                                f.querySelector('.del-btn').onclick = (e) => {e.stopPropagation(); VFS.delete(fname);};
                                f.onclick = () => openWindow('editor', systemApps.editor, {filename:fname, content:files[fname]});
                                list.appendChild(f);
                            });
                            lucide.createIcons();
                        };
                        renderFiles();
                        el.querySelector(`#refresh-fs-${id}`).onclick = renderFiles;
                        window.addEventListener('enti-fs-update', renderFiles);
                    }
                },
                'editor': {
                    title: 'Editor',
                    icon: '<i data-lucide="edit-3" class="w-5 h-5 text-orange-400"></i>',
                    width: 700, height: 550,
                    content: `<div class="flex flex-col h-full"><div class="flex items-center gap-2 p-2 bg-slate-800 border-b border-slate-700 overflow-x-auto no-scrollbar"><input type="text" id="filename-{{ID}}" placeholder="Name.txt" class="bg-slate-900 text-orange-400 text-sm px-3 py-2 rounded border border-slate-700 outline-none w-32 shrink-0"><div class="flex-grow"></div><button id="save-{{ID}}" class="flex items-center gap-1 px-3 py-2 bg-slate-700 text-white text-xs rounded font-bold"><i data-lucide="save" class="w-4 h-4"></i> Save</button></div><textarea id="content-{{ID}}" class="flex-grow bg-[#1e293b] text-gray-200 p-4 outline-none resize-none font-mono text-sm"></textarea></div>`,
                    init: (el, id, data) => {
                        const nameIn = el.querySelector(`#filename-${id}`); const area = el.querySelector(`#content-${id}`);
                        if(data){nameIn.value=data.filename; area.value=data.content;}
                        el.querySelector(`#save-${id}`).onclick=()=>{VFS.save(nameIn.value||"Unbenannt.txt", area.value);};
                    }
                },
                'browser': {
                    title: 'EntiNet',
                    icon: '<i data-lucide="globe" class="w-5 h-5 text-blue-400"></i>',
                    width: 800, height: 600,
                    content: `<div class="flex flex-col h-full"><div class="flex items-center gap-2 p-2 bg-slate-800 border-b border-slate-700"><input type="text" id="url-input-{{ID}}" value="https://www.google.com/search?q=EntiWebOS&igu=1" class="flex-grow bg-slate-900 text-gray-300 text-sm px-4 py-2 rounded-full border border-slate-700 focus:border-orange-500 outline-none"><button id="nav-go-{{ID}}" class="w-8 h-8 flex items-center justify-center bg-orange-600 rounded-full text-white"><i data-lucide="arrow-right" class="w-4 h-4"></i></button></div><iframe id="browser-frame-{{ID}}" src="" class="flex-grow bg-white w-full h-full border-none"></iframe></div>`,
                    init: (el, id) => {
                        const fr = el.querySelector(`#browser-frame-${id}`); const inp = el.querySelector(`#url-input-${id}`);
                        const load = ()=>{ let u=inp.value; if(!u.startsWith('http')) u='https://www.google.com/search?q='+encodeURIComponent(u)+'&igu=1'; fr.src=u; };
                        el.querySelector(`#nav-go-${id}`).onclick=load; inp.onkeydown=(e)=>{if(e.key==='Enter')load();}; load();
                    }
                },
                'gemini': {
                    title: 'EntiGemini',
                    icon: '<i data-lucide="bot" class="w-5 h-5 text-orange-400"></i>',
                    width: 400, height: 600,
                    content: `<div class="flex flex-col h-full bg-slate-900"><div id="chat-hist-{{ID}}" class="flex-grow p-4 overflow-y-auto flex flex-col gap-2"></div><div class="p-3 bg-slate-800 flex gap-2"><input id="chat-in-{{ID}}" class="flex-grow bg-slate-900 text-white rounded-full px-4 py-2 outline-none border border-slate-700 focus:border-orange-500"><button id="chat-send-{{ID}}" class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center text-white"><i data-lucide="send" class="w-4 h-4"></i></button></div></div>`,
                    init: (el, id) => {
                        const h = el.querySelector(`#chat-hist-${id}`); const inp = el.querySelector(`#chat-in-${id}`);
                        const add = (txt, usr) => { const d = document.createElement('div'); d.className = `chat-bubble ${usr?'chat-user':'chat-bot'}`; d.innerText=txt; h.appendChild(d); h.scrollTop=h.scrollHeight; };
                        add("Hallo! Ich bin dein Assistent.", false);
                        const send = async () => {
                            const txt = inp.value.trim(); if(!txt)return; inp.value=''; add(txt, true);
                            try {
                                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:txt}]}]}) });
                                const d = await resp.json(); add(d.candidates?.[0]?.content?.parts?.[0]?.text||"Fehler", false);
                            } catch(e){add("Offline.", false);}
                        };
                        el.querySelector(`#chat-send-${id}`).onclick=send; inp.onkeydown=(e)=>{if(e.key==='Enter')send();};
                    }
                },
                'featureExplorer': {
                    title: `Feature Galaxy ${featuresTotal}`,
                    icon: '<i data-lucide="sparkles" class="w-5 h-5 text-amber-300"></i>',
                    width: 940, height: 640,
                    content: `
                        <div class="flex flex-col h-full bg-slate-900">
                            <div class="p-4 border-b border-slate-800 flex flex-col gap-3">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-orange-400 text-xs font-bold uppercase tracking-[0.08em]">Kompaktes Update</div>
                                        <div class="text-xl sm:text-2xl font-extrabold text-white">${featuresTotal} neue Apps & Features</div>
                                        <p class="text-xs text-gray-400">Durchsuche, starte oder entdecke die kuratierten Micro-Apps.</p>
                                    </div>
                                    <div class="text-right">
                                        <div id="feature-count-{{ID}}" class="text-2xl font-black text-amber-300">${featuresTotal}</div>
                                        <div class="text-[11px] uppercase text-gray-400">bereitgestellt</div>
                                    </div>
                                </div>
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <div class="relative flex-grow">
                                        <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                                        <input id="feature-search-{{ID}}" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 pl-10 pr-4 text-white text-sm focus:border-orange-500 outline-none" placeholder="Nach ${featuresTotal} Apps suchen...">
                                    </div>
                                    <button id="feature-toggle-{{ID}}" class="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-xs text-gray-200 font-semibold">Alle anzeigen</button>
                                    <button id="feature-random-{{ID}}" class="px-3 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg text-xs font-bold text-white shadow">Zuf√§llige App</button>
                                </div>
                            </div>
                            <div id="feature-list-{{ID}}" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 p-4 overflow-y-auto flex-grow"></div>
                        </div>
                    `,
                    init: (el, id) => {
                        const list = el.querySelector(`#feature-list-${id}`);
                        const search = el.querySelector(`#feature-search-${id}`);
                        const counter = el.querySelector(`#feature-count-${id}`);
                        const toggle = el.querySelector(`#feature-toggle-${id}`);
                        const randomBtn = el.querySelector(`#feature-random-${id}`);
                        let showAll = false;

                        const renderList = () => {
                            const term = search.value.toLowerCase();
                            const filtered = Object.entries(microApps).filter(([, app]) =>
                                app.title.toLowerCase().includes(term) || app.category.toLowerCase().includes(term)
                            );

                            const limit = showAll ? filtered.length : Math.min(6, filtered.length);
                            list.innerHTML = '';

                            filtered.slice(0, limit).forEach(([key, app]) => {
                                const card = document.createElement('div');
                                card.className = 'bg-slate-800/70 border border-slate-700 rounded-xl p-3 flex flex-col gap-2 shadow-lg';
                                card.innerHTML = `
                                    <div class="flex items-center justify-between gap-2">
                                        <div class="flex items-center gap-2 text-sm font-semibold text-white">${app.icon}<span>${app.title}</span></div>
                                        <span class="text-[10px] px-2 py-1 bg-slate-900 rounded-full text-gray-400 border border-slate-700">${app.category}</span>
                                    </div>
                                    <p class="text-xs text-gray-400">Teil des kompakten 10er Packs mit sofort startbaren Micro-Apps.</p>
                                    <div class="flex gap-2">
                                        <button class="flex-1 py-2 rounded-lg bg-orange-600 hover:bg-orange-500 text-white text-xs font-bold" data-key="${key}">Starten</button>
                                        <button class="px-3 py-2 rounded-lg bg-slate-700 text-[11px] text-gray-200 border border-slate-600" data-preview="${key}">Preview</button>
                                    </div>
                                `;

                                card.querySelector('[data-key]').onclick = () => openWindow(key, systemApps[key]);
                                card.querySelector('[data-preview]').onclick = () => {
                                    navigator.clipboard?.writeText(app.title + ' ¬∑ ' + app.category).catch(() => {});
                                    card.classList.add('ring-2', 'ring-orange-500');
                                    setTimeout(() => card.classList.remove('ring-2', 'ring-orange-500'), 500);
                                };

                                list.appendChild(card);
                            });

                            counter.textContent = `${filtered.length} / ${featuresTotal}`;
                            toggle.textContent = showAll ? 'Top 6 anzeigen' : 'Alle anzeigen';
                            lucide.createIcons();
                        };

                        search.oninput = () => { showAll = search.value.length > 0; renderList(); };
                        toggle.onclick = () => { showAll = !showAll; renderList(); };
                        randomBtn.onclick = () => {
                            const keys = Object.keys(microApps);
                            const randomKey = keys[Math.floor(Math.random() * keys.length)];
                            openWindow(randomKey, systemApps[randomKey]);
                        };

                        renderList();
                    }
                }
            };

            const systemApps = { ...coreApps, ...microApps };

            // --- Combine and Render ---
            const renderAllApps = () => {
                desktop.innerHTML = '';
                const menuList = document.getElementById('start-menu-list');
                menuList.innerHTML = '';
                
                const customApps = AppManager.getCustomApps();
                allApps = { ...systemApps, ...customApps }; // Merge objects

                Object.entries(allApps).forEach(([id, app]) => {
                    // Desktop Icon (optional)
                    const iconHtml = app.isCustom ? `<span class="text-3xl">${app.iconEmoji}</span>` : app.icon.replace('w-5 h-5', 'w-8 h-8');

                    if (app.showOnDesktop !== false) {
                        const iconContainer = document.createElement('div');
                        iconContainer.className = 'app-icon-container w-[80px] h-[95px] sm:w-24 sm:h-28 flex flex-col items-center justify-start pt-2 rounded-lg cursor-pointer mb-2 select-none relative group';
                        iconContainer.innerHTML = `
                            <div class="p-3 rounded-2xl bg-slate-800/60 mb-1 shadow-lg border border-slate-700 flex items-center justify-center w-14 h-14 sm:w-16 sm:h-16">
                                ${iconHtml}
                            </div>
                            <span class="text-[11px] sm:text-xs font-medium text-gray-200 text-shadow text-center leading-tight px-1 bg-slate-900/30 rounded pb-0.5 truncate w-full">${app.title}</span>
                        `;

                        if (app.isCustom) {
                            const badge = document.createElement('div');
                            badge.className = 'delete-badge';
                            badge.innerHTML = '√ó';
                            badge.onclick = (e) => { e.stopPropagation(); if(confirm(`${app.title} l√∂schen?`)) AppManager.uninstall(id); };
                            iconContainer.appendChild(badge);
                        }

                        iconContainer.onclick = () => { openWindow(id, app); startMenu.style.display = 'none'; };
                        desktop.appendChild(iconContainer);
                    }

                    // Start Menu Item (optional)
                    if (app.hideFromStart !== true) {
                        const item = document.createElement('button');
                        item.className = 'w-full flex items-center gap-4 p-3 active:bg-slate-700/50 rounded-xl transition text-left text-sm font-medium text-gray-200 hover:bg-slate-800';
                        const listIcon = app.isCustom ? `<span class="text-xl">${app.iconEmoji}</span>` : app.icon;
                        item.innerHTML = `<div class="p-2 bg-slate-800 rounded-lg">${listIcon}</div> <span>${app.title}</span>`;
                        item.setAttribute('data-search', app.title.toLowerCase());
                        item.onclick = () => { openWindow(id, app); startMenu.style.display = 'none'; };
                        menuList.appendChild(item);
                    }
                });
                lucide.createIcons();
            };

            // --- Search Logic ---
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const items = document.querySelectorAll('#start-menu-list button');
                let found = false;
                
                items.forEach(item => {
                    if (item.getAttribute('data-search').includes(term)) {
                        item.style.display = 'flex';
                        found = true;
                    } else {
                        item.style.display = 'none';
                    }
                });

                // Web Search Fallback
                const fallback = document.getElementById('search-fallback');
                if (!found && term.length > 0) {
                    fallback.style.display = 'flex';
                    fallback.innerHTML = `
                        <div class="p-2 bg-slate-800 rounded-lg"><i data-lucide="search" class="w-5 h-5 text-blue-400"></i></div>
                        <span>Suche nach "<b>${e.target.value}</b>" im Web</span>
                    `;
                    fallback.onclick = () => {
                        openWindow('browser', systemApps.browser);
                        setTimeout(() => {
                            const win = activeWindow;
                            const iframe = win.querySelector('iframe');
                            const input = win.querySelector('input');
                            const url = 'https://www.google.com/search?q=' + encodeURIComponent(e.target.value) + '&igu=1';
                            iframe.src = url;
                            input.value = url;
                        }, 100);
                        startMenu.style.display = 'none';
                        searchInput.value = '';
                    };
                    lucide.createIcons();
                } else {
                    fallback.style.display = 'none';
                }
            });

            // --- Init ---
            window.addEventListener('enti-apps-update', renderAllApps);
            renderAllApps();

            startMenuButton.onclick = (e) => { e.stopPropagation(); startMenu.style.display = startMenu.style.display==='flex'?'none':'flex'; searchInput.focus(); };
            document.onclick = (e) => { if (!startMenu.contains(e.target) && e.target !== startMenuButton) startMenu.style.display = 'none'; };
            
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock').innerHTML = `<div class="text-sm sm:text-base font-bold text-gray-200 leading-none">${now.toLocaleTimeString('de-DE', {hour:'2-digit',minute:'2-digit'})}</div>`;
            }, 1000);

            // --- Developer Toolkit: 120 Utility Functions ---
            const createUtilityFunction = (index) => {
                const label = `utilityFn${index}`;
                return (...args) => {
                    const numbers = args.map((value) => Number(value) || 0);
                    const total = numbers.reduce((sum, value) => sum + value, 0);
                    const average = numbers.length ? total / numbers.length : index;
                    const range = numbers.length ? Math.max(...numbers) - Math.min(...numbers) : 0;

                    return {
                        name: label,
                        index,
                        total,
                        average,
                        range,
                        isEvenIndex: index % 2 === 0,
                        formatted: `${label}: ${total}`
                    };
                };
            };

            const developerToolkit = (() => {
                const library = {};
                for (let i = 1; i <= 120; i++) {
                    library[`utilityFn${i}`] = createUtilityFunction(i);
                }

                library.listFunctions = () =>
                    Object.keys(library)
                        .filter((key) => key.startsWith('utilityFn'))
                        .map((key) => ({ name: key, index: Number(key.replace('utilityFn', '')) }))
                        .sort((a, b) => a.index - b.index);

                return library;
            })();

            window.entiDeveloperToolkit = developerToolkit;
        });
    </script>
</head>
<body class="select-none">

    <!-- Desktop Area -->
    <div id="desktop" class="p-4 flex flex-row flex-wrap content-start gap-2 sm:gap-4"></div>

    <!-- Start Menu -->
    <div id="start-menu">
        <!-- Search Bar -->
        <div class="mb-4 relative">
            <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
            <input type="text" id="start-search" placeholder="Suchen..." class="w-full bg-slate-900 border border-slate-700 rounded-xl py-2 pl-10 pr-4 text-white text-sm focus:border-orange-500 outline-none placeholder:text-gray-500">
        </div>

        <!-- Search Fallback Button (Hidden by default) -->
        <button id="search-fallback" class="w-full flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl transition text-left text-sm font-medium text-gray-200 hover:bg-slate-800 mb-2" style="display: none;"></button>

        <!-- Apps List -->
        <div id="start-menu-list" class="space-y-1 overflow-y-auto flex-grow no-scrollbar"></div>
        
        <!-- Footer -->
        <div class="mt-3 pt-2 border-t border-slate-700/50 flex-shrink-0">
            <button onclick="location.reload()" class="w-full flex items-center gap-3 p-3 text-red-400 active:bg-red-900/20 rounded-xl transition text-sm font-medium">
                <i data-lucide="power" class="w-4 h-4"></i> <span class="text-xs font-bold uppercase">Neustarten</span>
            </button>
        </div>
    </div>

    <!-- Taskbar -->
    <div id="taskbar" class="flex items-center px-2 sm:px-3 gap-2 safe-area-bottom">
        <button id="start-button" class="w-11 h-11 flex-shrink-0 flex items-center justify-center rounded-xl active:bg-slate-800 transition text-orange-500">
            <i data-lucide="layout-grid" class="w-6 h-6"></i>
        </button>
        <div class="w-[1px] h-6 bg-slate-700 mx-1 hidden sm:block"></div>
        <div id="taskbar-apps" class="flex-grow flex items-center overflow-x-auto no-scrollbar h-full mask-linear-fade"></div>
        <div id="clock" class="flex-shrink-0 flex flex-col items-end justify-center px-2 sm:px-3 h-full rounded cursor-default min-w-[50px]"></div>
    </div>

</body>
</html>
